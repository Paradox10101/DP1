const WebSocket = require('ws');
const {findNextLocation} = require('./funcionesRuta');
const server = new WebSocket.Server({ port: 8080 });
let vehiculos = [{id:1 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 90,estado: 'En Tránsito', codigo: 'A001' , velocidad: 30, tipo: 'A'},{id:2 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 90,estado: 'En Tránsito', codigo: 'A002' , velocidad: 30, tipo: 'A'},{id:3 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 90,estado: 'En Tránsito', codigo: 'A003' , velocidad: 30, tipo: 'A'},{id:4 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 90,estado: 'En Tránsito', codigo: 'A004' , velocidad: 30, tipo: 'A'},{id:5 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B001' , velocidad: 30, tipo: 'B'},{id:6 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B002' , velocidad: 30, tipo: 'B'},{id:7 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B003' , velocidad: 30, tipo: 'B'},{id:8 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B004' , velocidad: 30, tipo: 'B'},{id:9 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B005' , velocidad: 30, tipo: 'B'},{id:10 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B006' , velocidad: 30, tipo: 'B'},{id:11 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B007' , velocidad: 30, tipo: 'B'},{id:12 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C001' , velocidad: 30, tipo: 'C'},{id:13 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C002' , velocidad: 30, tipo: 'C'},{id:14 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C003' , velocidad: 30, tipo: 'C'},{id:15 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C004' , velocidad: 30, tipo: 'C'},{id:16 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C005' , velocidad: 30, tipo: 'C'},{id:17 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C006' , velocidad: 30, tipo: 'C'},{id:18 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C007' , velocidad: 30, tipo: 'C'},{id:19 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C008' , velocidad: 30, tipo: 'C'},{id:20 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C009' , velocidad: 30, tipo: 'C'},{id:21 , geocode: [-12.045919, -77.030495], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C010' , velocidad: 30, tipo: 'C'},{id:22 , geocode: [-8.111764, -79.02869], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 90,estado: 'En Tránsito', codigo: 'A005' , velocidad: 30, tipo: 'A'},{id:23 , geocode: [-8.111764, -79.02869], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B008' , velocidad: 30, tipo: 'B'},{id:24 , geocode: [-8.111764, -79.02869], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B009' , velocidad: 30, tipo: 'B'},{id:25 , geocode: [-8.111764, -79.02869], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B010' , velocidad: 30, tipo: 'B'},{id:26 , geocode: [-8.111764, -79.02869], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C011' , velocidad: 30, tipo: 'C'},{id:27 , geocode: [-8.111764, -79.02869], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C012' , velocidad: 30, tipo: 'C'},{id:28 , geocode: [-8.111764, -79.02869], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C013' , velocidad: 30, tipo: 'C'},{id:29 , geocode: [-8.111764, -79.02869], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C014' , velocidad: 30, tipo: 'C'},{id:30 , geocode: [-8.111764, -79.02869], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C015' , velocidad: 30, tipo: 'C'},{id:31 , geocode: [-8.111764, -79.02869], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C016' , velocidad: 30, tipo: 'C'},{id:32 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 90,estado: 'En Tránsito', codigo: 'A006' , velocidad: 30, tipo: 'A'},{id:33 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B011' , velocidad: 30, tipo: 'B'},{id:34 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B012' , velocidad: 30, tipo: 'B'},{id:35 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B013' , velocidad: 30, tipo: 'B'},{id:36 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B014' , velocidad: 30, tipo: 'B'},{id:37 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 45,estado: 'En Tránsito', codigo: 'B015' , velocidad: 30, tipo: 'B'},{id:38 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C017' , velocidad: 30, tipo: 'C'},{id:39 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C018' , velocidad: 30, tipo: 'C'},{id:40 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C019' , velocidad: 30, tipo: 'C'},{id:41 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C020' , velocidad: 30, tipo: 'C'},{id:42 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C021' , velocidad: 30, tipo: 'C'},{id:43 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C022' , velocidad: 30, tipo: 'C'},{id:44 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C023' , velocidad: 30, tipo: 'C'},{id:45 , geocode: [-16.398815, -71.53702], ubicacionActual: 'Arequipa', ubicacionSiguiente: 'Putumayo', fechaDeInicio: '26/08/2024, 03:45 PM', tiempoRestante: '1d 3h', capacidadUsada: 20, capacidadMaxima: 30,estado: 'En Tránsito', codigo: 'C024' , velocidad: 30, tipo: 'C'}]

server.on('connection', (ws) => {
    console.log('Cliente conectado');
    
    let seconds = 0
    
    //Envio de mensaje por cada unidad de segundo
    const intervalId = setInterval(() => {
        seconds++
        const now = new Date()
        const currentTime = now.toLocaleTimeString()
        vehiculos = vehiculos.map((vehiculo)=>
            ({...vehiculo,
                //geocode: [vehiculo.geocode[0] + 0.01, vehiculo.geocode[1] + 0.01]
                /*
                geocode: [
                    vehiculo.geocode[0] + (Math.random() < 0.5 ? -0.01 : 0.01),
                    vehiculo.geocode[1] + (Math.random() < 0.5 ? -0.01 : 0.01)]
                }
                */
                geocode: findNextLocation(vehiculo.geocode, [-2.4471967, -72.66825])
                
            }))

        const message = JSON.stringify({
            hora: currentTime,
            contador: seconds,
            vehiculos: vehiculos
        })
        
        ws.send(message)
    }, 1000);


    ws.on('message', (message) => {
        console.log(`Mensaje recibido: ${message}`);
    
        // Procesar el mensaje y enviar una respuesta
        const response = `Algo: ${message}`;
        ws.send(response);
    });

    ws.on('close', () => {
        console.log('Cliente desconectado');
        clearInterval(intervalId);
    });
});

console.log('Servidor WebSocket escuchando en ws://localhost:8080');


